from functools import partial

from evaluation.flocking import evaluate_flocking
from evaluation.scale import scale_test
from models.boid import boid_step
from models.dmbsmf_boid import dmbsmf_boid_step
from models.generic_MLP_boid import generic_MLP_boid_step, MLP_boid
from models.generic_multi_MLP_boid import multi_MLP_neighbour_boid, multi_MLP_strength_boid, generic_multi_MLP_boid_step
from models.mti_boid import mti_boid_step


def scale_and_density():
    scale_test(partial(boid_step, test=True), name="boid",
               save_to_file=True, num_pop=30)

    scale_test(partial(dmbsmf_boid_step), name="dmbsmf_boid",
               save_to_file=True, num_pop=30)

    scale_test(partial(mti_boid_step, state_list=[0 for _ in range(300)]), name="mti_boid",
               save_to_file=True, num_pop=30)


def flocking():
    evaluate_flocking(partial(dmbsmf_boid_step), name="dmbsmf_boid")
    evaluate_flocking(partial(mti_boid_step, state_list=[0 for _ in range(300)]), name="mti_boid")
    evaluate_flocking(boid_step, name="boid")


def MLP_eval():
    generic_MLP_nnet = MLP_boid()
    generic_MLP_nnet.set_weights(
        [0.8241595282040887, -0.6992258978108807, 0.38227371798559373, 0.459490434541305, 1.4566373134419046,
         0.7132468000674838, -1.0485073612961444, -0.50786331818114, 0.5782492096890273, -0.19835462618605365,
         0.7022086621474112, 0.0629168676301528, -0.2975597061320402, 0.09981251294223462, -0.08252861230571046,
         1.2552241825814932, 2.6505551925698794, 1.1516023720598374, 0.5848838856993818, 1.0916508230021171,
         -1.50281434185076, 1.2352901312993654, -0.5728918139728568, 0.5276530713382556, -0.8525495197595261,
         -0.7846504289565417, 1.7106917583341994, 0.9704347491403092, -0.6953462672993985, -1.7391058679346683,
         -0.024038289511668753, 0.30834507489942325, -1.8895965623304012, -0.22029757276597656, 0.15288298017138519,
         0.19830478408645602, -0.704963120485925, -0.05931879864493742, 1.3527297720672764, -0.8263321256736815,
         0.10552072528653003, -1.3020932839966755, 1.626596449924685, 1.8253536080028692, -1.7031540354151695,
         1.8395312031409183, -0.5013209427277575, -0.9152188413322107, 1.2036836837821419, -0.7461384422809397,
         1.955490374515342, -0.16968828087083226, -0.5523093099151889, -1.7835801039601105, -1.713504220708893,
         0.47148879448516146, -0.6573629923012185, -0.005225255265979584, -1.5519110089395254, 0.3174394037661288,
         0.08924736622264434, 0.6701552078813897, 0.050124822186478096, 0.8575819700951564, 0.594394508878062,
         -0.36601068683376825, -0.8596994500825571, 0.3588955878310982, -0.9873104876690193, 0.47777420512258517,
         1.077858437900252, 0.9768946549941883, -0.20247632591743048, 1.659681715667924, 0.7062568990301223,
         0.81448505819711, 0.5741516551515262, 0.38953770292197487, -0.1461073410353848, 0.10429788504247177,
         0.7638951469833525, 0.7663895873681941, -1.5945956579235812, -2.38957477485324, -0.8085406029524741,
         1.3965279057296955, -0.9410409767545697, -0.5586532569920296, 0.5461486864118039, -1.0281228342415845,
         0.22252054665739565, 2.88648398343898, 0.7801935479544551, 0.7402730198324893, 0.01107174028028017,
         0.12349827819825403, 0.869673975823964, -0.16877221724051783, 3.738934509475315, 0.5441768093785742,
         0.8007128639157524, -0.07887572473020482, 1.7061912019143302, -0.8478477840355156, -0.6795019833577725,
         0.445490301075659, 0.3618063926592242, -1.0919289213455168, 0.3756193585019467, 0.5526686783796289,
         0.3927925857004052, 0.47472509316280015, 0.6217494433468076, -0.9167581275894562, 1.6579485395151754,
         -0.5117686615919366, -0.004027476809901356, -0.06890911757205667, 0.06800164656825206, 1.0772444018488554,
         0.25204163178434263, 2.3739089385074403, 0.5187584591074798, 0.7295171222318155, -1.1592328857548448,
         0.20546107701015706, 1.033771914864523, 0.9063421796459086, 0.19738985828658526, -0.3426285584110753,
         0.501710397857206, -1.5115796476393126, 1.8047706025823245, -0.6184223259115966, 0.9336082490208855,
         -0.8073793243829622, 1.1805247782396333, 1.0201963916318137, -1.3275089991663558, -0.690834410633558,
         -0.700097216100388, 4.137721232787233, -0.6477804022644118, 0.7723081469236752, -0.9820697861591647,
         0.9986661712268616, 0.5438211558675528, -0.6223956890918367, 0.17370967645313634, 1.026196183655219,
         0.16505209755791173, 0.4386673083405388, 0.25723753536963445, -0.004296526478532792, 0.7482732831788383,
         -7.601844724505757e-05, -0.06699317945450711, -0.7076842893730969, -2.109912916186765, -2.0527988691003056,
         2.6521780246992317, 1.1270260070600435, -1.1698670732827738, 0.439858498270984, -1.5649090040042126,
         0.2523274452205294, -0.8962776545661666, 0.45044649391739244, 0.06271879450927258, -2.6270120619652344,
         0.6181243790214795, -0.3131600048623331, -0.6105244915172339, 0.17013604535742405, 0.2822258933816579,
         1.2270984393342668, 0.15023410081347077, -1.6420546703417984, 0.1830100160639558, 1.153825698692062,
         -2.6730928274093317, -1.8360304550895359, 0.16982490005992681, 0.1281907796719784, -0.7383070272429635,
         -1.8278937582279335, 0.6015865409645332, 1.5650043796925055, -0.7177694572055124, -1.8590280343935328,
         -1.3019605213946905, 0.7987146438731995, 2.6838898829319437, -0.8122617862510055, 0.005534797987876691,
         -0.9377637245459799, 0.2603932370244919, 0.03241920726106171, 0.045734453670141326, 1.546540497575876,
         -1.1482262307616522, -1.3417190453935013, 0.1699191856560093, -0.809886306420024, -1.0661083066774044,
         0.6119396120889683, 0.5583697243666034, 0.2652543933240733, -0.14924122679936064, -0.18434181737388444,
         -0.5231157186438741, -0.5573909871152277, 0.3813538688758894, 0.8414445276928765, -1.1537686667107092,
         1.0726522137344041, 1.607030500584053, -0.8384087324424735, 0.3561366905261329, -0.37283422017326917,
         2.1813421093287864, 0.41760357724430064, -1.7599428471318888, -1.4435379582192371, -0.6532850916816381,
         0.31876667173126755, -0.5731042690885729, -0.8994616288310245, -0.333645194488652, 0.6082708998469134,
         -0.755929586508516, -0.6451167168255212
         ])

    scale_test(partial(generic_MLP_boid_step, nnet=generic_MLP_nnet), name="generic_MLP_boid",
               save_to_file=True, num_pop=30)

    coh_neighbourhood_nnet = multi_MLP_neighbour_boid()
    sep_neighbourhood_nnet = multi_MLP_neighbour_boid()
    ali_neighbourhood_nnet = multi_MLP_neighbour_boid()
    coh_nnet = multi_MLP_strength_boid()
    sep_nnet = multi_MLP_strength_boid()
    ali_nnet = multi_MLP_strength_boid()

    individual = [0.512794765394833, -1.4636441748569764, -0.6059670987445895, 1.281287513790976, 0.8638452000907536,
                  2.028140586599232, -2.1677543513249375, -0.07140115590682108, -0.47523301207171964,
                  0.6751253206055128, -0.11003589844127686, -1.7101348879152287, 0.845479876326671, 0.35184837111384853,
                  1.0344585947937803, 0.3194119270502136, 0.4905937378718923, 0.6918731140226201, -1.7522597379209408,
                  -0.6658528809771946, 0.7084969115067441, -0.4130740730655748, -0.039290729206890085,
                  0.5853277127243948, -0.1435009343263719, -0.4908999821516771, -0.010472042412919174,
                  2.378183079068957, 0.6104271387975344, 1.172186844266607, -1.6159526521949592, 0.47839967241110093,
                  0.6042059789751137, -1.2172903254900442, -0.31355322453104334, -0.1006218967414526,
                  1.3109297101141923, -0.34425015707731677, 0.1389208452405412, -0.3561999068039592, 1.4935934464962821,
                  0.5527648192545566, -1.9430423915642365, -1.3131800619677705, 0.8420478094183221, -1.04918331961867,
                  0.8244597529578772, 0.12423089538740406, 1.2934433753285217, -0.40638917375619654,
                  -1.5154972306060026, 1.9796263513762706, 2.212468635741985, -0.10297924574970296, 1.4696443387024742,
                  -2.375537179533599, -0.24655463196535463, 0.18126468593439266, 1.281040978420184, -1.135026345004171,
                  -0.6404881594354928, -0.43637379519619646, 1.4332093562325279, -0.20926516178333815,
                  0.140259917967621, 1.9354083209983763, 0.3892025694513277, 0.25029759828203874, 0.6175471169046092,
                  -1.2327266471920832, 0.47997708016078233, 1.1844202393471444, -0.18217212318627557,
                  -0.02895101389544895, -1.104856854482624, -0.1702527884454093, 0.4372158992753524, 0.2075451482100283,
                  0.07533373985028359, 0.9604328978352349, -2.2360242432482598, -0.1551608538199034, 1.6799067551228024,
                  -0.442670097259889, -0.26754116156253066, 3.2036051626987705, -0.058029431665870025,
                  1.4386550865986358, 1.0630208879870682, -1.1842219718662352, 0.3210427232257479, 0.776509984129868,
                  -0.7048477760976951, -0.08994334491464634, -0.4460375948243621, 0.6648711568703566, 0.272299805287631,
                  0.7826522417993702, -0.46720629168292127, -1.0047814492804572, 0.6967656538763772,
                  -0.9769314870335161, -0.1658165219669958, -0.8640068124672858, -1.8269629595127341,
                  -0.5471733276687312, -0.02882979537973926, -0.42398856376925365, 0.2109433166960704,
                  -0.01632397865829993, 1.2328727601396507, 0.3388700434739299, -1.3721230289603088,
                  -1.7588776357672087, -1.389867526506166, 0.12271545491522545, -1.302744452371887, -0.7032723325284013,
                  0.20682494166287604, 0.3290706776302087, 0.2892998465459491, -1.2126850805553986, 1.1893618580992311,
                  -0.31995453763605597, -0.45341235001239755, -0.509543769809065, -0.8613997598102445,
                  -0.7027747700511352, -0.558406201432635, 0.8862814865344428, 2.1511211922183215, -0.67306936600517,
                  -1.1342270632875686, -1.0766210543614338, 0.07308298294133761, -1.9056305052540685,
                  -0.8099880991198815, -2.3332828121046205, 1.279787485150777, 0.4047262429966319, -0.7831053362824875,
                  0.24041374752883543, 2.213812452957696, -1.3729539927693741
                  ]

    running_index = 0

    coh_neighbourhood_nnet.set_weights(individual[0:len(coh_neighbourhood_nnet.get_weights())])
    running_index += len(coh_neighbourhood_nnet.get_weights())
    sep_neighbourhood_nnet.set_weights(
        individual[running_index:running_index + len(sep_neighbourhood_nnet.get_weights())])
    running_index += len(sep_neighbourhood_nnet.get_weights())
    ali_neighbourhood_nnet.set_weights(
        individual[running_index:running_index + len(ali_neighbourhood_nnet.get_weights())])
    running_index += len(ali_neighbourhood_nnet.get_weights())

    coh_nnet.set_weights(individual[running_index:running_index + len(coh_nnet.get_weights())])
    running_index += len(coh_nnet.get_weights())
    sep_nnet.set_weights(individual[running_index:running_index + len(sep_nnet.get_weights())])
    running_index += len(sep_nnet.get_weights())
    ali_nnet.set_weights(individual[running_index:running_index + len(ali_nnet.get_weights())])

    algorithm = partial(generic_multi_MLP_boid_step,
                        coh_neighbourhood_nnet=coh_neighbourhood_nnet,
                        sep_neighbourhood_nnet=sep_neighbourhood_nnet,
                        ali_neighbourhood_nnet=ali_neighbourhood_nnet,
                        coh_nnet=coh_nnet,
                        sep_nnet=sep_nnet,
                        ali_nnet=ali_nnet,
                        )

    scale_test(algorithm, name="generic_multi_MLP_boid",
               save_to_file=True, num_pop=30)

    evaluate_flocking(partial(generic_MLP_boid_step, nnet=generic_MLP_nnet), name="generic_MLP_boid")
    evaluate_flocking(algorithm, name="generic_multi_MLP_boid")


def main():
    scale_and_density()
    flocking()
    MLP_eval()


if __name__ == "__main__":
    main()
